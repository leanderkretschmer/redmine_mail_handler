<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'mail_handler', :plugin => 'redmine_mail_handler' %>
  <%= javascript_include_tag 'mail_handler', :plugin => 'redmine_mail_handler' %>
<% end %>

<div class="contextual">
  <%= link_to "Zurück zur Übersicht", { :action => 'index' }, :class => 'icon icon-back' %>
  <%= link_to "Aktualisieren", { :action => 'deferred_mails' }, :class => 'icon icon-reload', :title => 'Seite neu laden' %>
  <%= link_to 'IMAP testen & neu laden', { :action => 'reload_deferred_mails' }, :method => :post, :class => 'icon icon-test', :title => 'IMAP-Verbindung testen und E-Mails neu laden' %>
</div>

<h2>Zurückgestellte E-Mails verwalten</h2>

<!-- Suchformular -->
<div class="search-form">
  <%= form_tag({ :action => 'deferred_mails' }, { :method => :get, :id => 'search_form' }) do %>
    <fieldset class="collapsible">
      <legend onclick="toggleFieldset(this);">Suche</legend>
      <div>
        <p>
          <label for="search_from">Absender:</label>
          <%= text_field_tag 'search_from', @search_from, :placeholder => 'E-Mail-Adresse des Absenders', :size => 30 %>
        </p>
        <p>
          <label for="search_subject">Betreff:</label>
          <%= text_field_tag 'search_subject', @search_subject, :placeholder => 'Betreff der E-Mail', :size => 30 %>
        </p>
        <p>
          <%= submit_tag 'Suchen', :class => 'small' %>
          <%= link_to 'Zurücksetzen', { :action => 'deferred_mails' }, :class => 'small' %>
        </p>
      </div>
    </fieldset>
  <% end %>
</div>

<% if @deferred_mails.empty? %>
  <div class="nodata">
    <% if @search_from.present? || @search_subject.present? %>
      <p>Keine zurückgestellten E-Mails gefunden, die den Suchkriterien entsprechen.</p>
    <% else %>
      <p>Keine zurückgestellten E-Mails im IMAP-Ordner gefunden.</p>
    <% end %>
  </div>
<% else %>
  <!-- Ergebnisinfo -->
  <p class="search-results-info">
    <% if @search_from.present? || @search_subject.present? %>
      Gefunden: <%= @total_count %> E-Mails
      <% if @search_from.present? %>
        (Absender: "<%= h(@search_from) %>")
      <% end %>
      <% if @search_subject.present? %>
        (Betreff: "<%= h(@search_subject) %>")
      <% end %>
    <% else %>
      Insgesamt: <%= @total_count %> zurückgestellte E-Mails
      <% if defined?(@imap_connection_available) && !@imap_connection_available %>
        <em>(Beispieldaten - IMAP-Verbindung nicht verfügbar)</em>
      <% elsif defined?(@imap_connection_available) && @imap_connection_available %>
        <em>(Live-Daten aus IMAP)</em>
      <% end %>
    <% end %>
  </p>

  <%= form_tag({ :action => 'rescan_deferred_mails' }, { :method => :post, :id => 'deferred_mails_form' }) do %>
    
    <div class="autoscroll">
      <table class="list deferred-mails">
        <thead>
          <tr>
            <th class="checkbox">
              <%= check_box_tag 'select_all', '1', false, :onclick => 'toggleAllCheckboxes(this)' %>
            </th>
            <th>Von</th>
            <th>Betreff</th>
            <th>Zurückgestellt am</th>
            <th>Alter</th>
            <th>Läuft ab am</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          <% @deferred_mails.each do |mail| %>
            <tr class="<%= 'expired' if mail[:expired] %>">
              <td class="checkbox">
                <%= check_box_tag 'selected_ids[]', mail[:id], false, :class => 'mail-checkbox' %>
              </td>
              <td><%= h(mail[:from]) %></td>
              <td><%= h(mail[:subject]) %></td>
              <td><%= mail[:deferred_at] ? format_time(mail[:deferred_at]) : '-' %></td>
              <td>
                <% if mail[:deferred_at] %>
                  <% age_in_days = ((Time.current - mail[:deferred_at]) / 1.day).round %>
                  <% if age_in_days == 0 %>
                    <span class="age-new">Heute</span>
                  <% elsif age_in_days == 1 %>
                    <span class="age-recent">1 Tag</span>
                  <% elsif age_in_days < 7 %>
                    <span class="age-recent"><%= age_in_days %> Tage</span>
                  <% elsif age_in_days < 30 %>
                    <span class="age-old"><%= age_in_days %> Tage</span>
                  <% else %>
                    <span class="age-very-old"><%= age_in_days %> Tage</span>
                  <% end %>
                <% else %>
                  <span class="age-unknown">-</span>
                <% end %>
              </td>
              <td><%= mail[:expires_at] ? format_time(mail[:expires_at]) : '-' %></td>
              <td class="buttons">
                <%= link_to "Benutzer erstellen", 
                    { :action => 'create_user_from_mail', :message_id => mail[:message_id] }, 
                    :method => :post, 
                    :class => 'icon icon-user',
                    :title => 'Benutzer aus dieser E-Mail erstellen' %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="bulk-actions">
      <p>
        <strong>Ausgewählte E-Mails:</strong>
        <%= submit_tag "Neu scannen", :name => 'rescan', :class => 'small', :onclick => 'return confirmAction("Möchten Sie die ausgewählten E-Mails wirklich neu scannen?")' %>
        <%= submit_tag "Archivieren", :name => 'archive', :class => 'small', :onclick => 'return submitArchive()' %>
      </p>
    </div>

  <% end %>

      <!-- Pagination -->
      <% if @total_pages > 1 %>
        <div class="pagination">
          <ul>
            <% if @page > 1 %>
              <li><%= link_to "« Vorherige", { :page => @page - 1, :per_page => @per_page, :search_from => @search_from, :search_subject => @search_subject }, :class => 'pagination-arrow' %></li>
            <% end %>
            
            <% (1..@total_pages).each do |page| %>
              <% if page == @page %>
                <li class="current"><%= page %></li>
              <% elsif (page - @page).abs <= 2 || page == 1 || page == @total_pages %>
                <li><%= link_to page, { :page => page, :per_page => @per_page, :search_from => @search_from, :search_subject => @search_subject } %></li>
              <% elsif (page - @page).abs == 3 %>
                <li class="ellipsis">...</li>
              <% end %>
            <% end %>
            
            <% if @page < @total_pages %>
              <li><%= link_to "Nächste »", { :page => @page + 1, :per_page => @per_page, :search_from => @search_from, :search_subject => @search_subject }, :class => 'pagination-arrow' %></li>
            <% end %>
          </ul>
          
          <p class="pagination-info">
            Zeige <%= (@page - 1) * @per_page + 1 %> bis <%= [@page * @per_page, @total_count].min %> von <%= @total_count %> E-Mails
          </p>
          
          <!-- Per-Page-Auswahl -->
          <div class="per-page-options">
            <label>E-Mails pro Seite:</label>
            <% @per_page_options.each do |option| %>
              <% if option == @per_page %>
                <strong><%= option %></strong>
              <% else %>
                <%= link_to option, { :page => 1, :per_page => option, :search_from => @search_from, :search_subject => @search_subject } %>
              <% end %>
              <% unless option == @per_page_options.last %>|<% end %>
            <% end %>
          </div>
        </div>
      <% end %>

<% end %>

<!-- IMAP Debug-Informationen (minimiert) -->
<% if defined?(@imap_debug_info) && @imap_debug_info.present? %>
  <div class="debug-info-container">
    <div class="debug-info-header" onclick="toggleDebugInfo()">
      <span class="debug-info-title">IMAP Debug-Informationen</span>
      <span class="debug-info-toggle" id="debug-toggle">▼</span>
    </div>
    <div class="debug-info-content" id="debug-content" style="display: none;">
      <ul>
        <% @imap_debug_info.each do |info| %>
          <li class="debug-info-item <%= info.start_with?('✗') ? 'error' : (info.start_with?('ℹ') ? 'info' : 'success') %>">
            <%= h(info) %>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
<% end %>

<script type="text/javascript">
function toggleDebugInfo() {
  var content = document.getElementById('debug-content');
  var toggle = document.getElementById('debug-toggle');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▲';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▼';
  }
}

function toggleAllCheckboxes(masterCheckbox) {
  var checkboxes = document.querySelectorAll('.mail-checkbox');
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = masterCheckbox.checked;
  });
}

function confirmAction(message) {
  return confirm(message);
}

function submitArchive() {
  if (!confirm('Möchten Sie die ausgewählten E-Mails wirklich archivieren?')) {
    return false;
  }
  
  // Change form action to archive
  var form = document.getElementById('deferred_mails_form');
  form.action = '<%= url_for(:action => 'archive_deferred_mails') %>';
  return true;
}

function toggleFieldset(legend) {
  var fieldset = legend.parentNode;
  var div = fieldset.querySelector('div');
  if (div.style.display === 'none') {
    div.style.display = 'block';
    fieldset.classList.remove('collapsed');
  } else {
    div.style.display = 'none';
    fieldset.classList.add('collapsed');
  }
}

// Suchformular beim Laden der Seite einklappen wenn keine Suchkriterien vorhanden
document.addEventListener('DOMContentLoaded', function() {
  var searchFrom = '<%= @search_from %>';
  var searchSubject = '<%= @search_subject %>';
  var fieldset = document.querySelector('.search-form fieldset');
  
  if (!searchFrom && !searchSubject && fieldset) {
    var div = fieldset.querySelector('div');
    div.style.display = 'none';
    fieldset.classList.add('collapsed');
  }
});
</script>

<style>
.deferred-mails {
  width: 100%;
}

.deferred-mails th.checkbox,
.deferred-mails td.checkbox {
  width: 30px;
  text-align: center;
}

.deferred-mails tr.expired {
  background-color: #ffe6e6;
}

.status-expired {
  color: #d00;
  font-weight: bold;
}

.status-active {
  color: #080;
  font-weight: bold;
}

.bulk-actions {
  margin: 15px 0;
  padding: 10px;
  background-color: #f5f5f5;
  border: 1px solid #ddd;
}

.pagination {
  margin: 20px 0;
}

.pagination ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: inline-block;
}

.pagination li {
  display: inline-block;
  margin: 0 2px;
}

.pagination li a,
.pagination li.current {
  padding: 5px 10px;
  border: 1px solid #ddd;
  text-decoration: none;
}

.pagination li.current {
  background-color: #007acc;
  color: white;
  border-color: #007acc;
}

.pagination li a:hover {
  background-color: #f5f5f5;
}

.pagination li.ellipsis {
  padding: 5px 10px;
  color: #999;
  border: 1px solid transparent;
}

.pagination .pagination-arrow {
  font-weight: bold;
}

.pagination .pagination-arrow:hover {
  background-color: #007acc;
  color: white;
}

.pagination-info {
  margin-top: 10px;
  font-size: 0.9em;
  color: #666;
}

.per-page-options {
  margin-top: 10px;
  font-size: 0.9em;
}

.per-page-options label {
  margin-right: 10px;
}

.per-page-options a {
  margin: 0 3px;
  text-decoration: none;
}

.per-page-options a:hover {
  text-decoration: underline;
}

/* Suchformular Styles */
.search-form {
  margin: 20px 0;
}

.search-form fieldset {
  border: 1px solid #ddd;
  padding: 10px;
  margin: 10px 0;
}

.search-form fieldset.collapsed {
  padding-bottom: 5px;
}

.search-form legend {
  cursor: pointer;
  padding: 0 10px;
  font-weight: bold;
  color: #007acc;
}

.search-form legend:hover {
  text-decoration: underline;
}

.search-form p {
  margin: 10px 0;
}

.search-form label {
  display: inline-block;
  width: 80px;
  font-weight: bold;
}

.search-form input[type="text"] {
  margin-left: 10px;
}

.search-results-info {
  background-color: #f0f8ff;
  border: 1px solid #b0d4f1;
  padding: 8px 12px;
  margin: 10px 0;
  border-radius: 3px;
  font-weight: bold;
}

/* Debug-Informationen Styles */
.debug-info-container {
  margin: 20px 0;
  border: 1px solid #ddd;
  border-radius: 3px;
  background-color: #f9f9f9;
}

.debug-info-header {
  padding: 10px 15px;
  background-color: #f0f0f0;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
  user-select: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.debug-info-header:hover {
  background-color: #e8e8e8;
}

.debug-info-title {
  font-weight: bold;
  color: #333;
}

.debug-info-toggle {
  font-size: 12px;
  color: #666;
}

.debug-info-content {
  padding: 10px 15px;
}

.debug-info-content ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.debug-info-item {
  margin: 5px 0;
  font-family: monospace;
  font-size: 12px;
  padding: 3px 0;
}

.debug-info-item.error {
  color: #d00;
}

.debug-info-item.info {
  color: #666;
}

.debug-info-item.success {
  color: #080;
}
</style>