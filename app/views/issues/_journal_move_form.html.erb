<%# Eingabefeld für Journal-Verschiebung - Direkt sichtbar bei jedem Kommentar %>
<style>
  .journal-move-inline {
    margin: 8px 0;
    padding: 6px;
    background-color: #f9f9f9;
    border-left: 3px solid #ddd;
    font-size: 12px;
  }
  
  .journal-move-inline .move-form {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .journal-move-inline .move-label {
    color: #666;
    font-weight: normal;
    font-size: 11px;
  }
  
  .journal-move-inline .target-input {
    width: 60px;
    padding: 2px 4px;
    border: 1px solid #ccc;
    border-radius: 2px;
    font-size: 11px;
  }
  
  .journal-move-inline .move-btn {
    padding: 2px 8px;
    background: none;
    color: #666;
    border: 1px solid #ccc;
    border-radius: 2px;
    cursor: pointer;
    font-size: 11px;
    text-decoration: underline;
  }
  
  .journal-move-inline .move-btn:hover {
    color: #333;
    border-color: #999;
  }
  
  .journal-move-inline .move-btn:disabled {
    color: #999;
    cursor: not-allowed;
    text-decoration: none;
  }
</style>

<%= content_for :header_tags do %>
  <%= stylesheet_link_tag 'simple_journal_move', plugin: 'redmine_mail_handler' %>
  <%= javascript_include_tag 'simple_journal_move', plugin: 'redmine_mail_handler' %>
<% end %>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // Füge Move-Formulare zu allen Journals hinzu
    addInlineMoveFormsToJournals();
  });
  
  function addInlineMoveFormsToJournals() {
    // Prüfe ob wir in einem Mail Handler Plugin Ticket sind
    if (!isMailHandlerTicket()) return;
    
    // Finde alle Journal-Elemente mit echten Kommentaren
    const journals = document.querySelectorAll('#history .journal');
    
    journals.forEach(function(journal) {
      // Prüfe ob es ein echter Kommentar ist (hat journal-notes)
      const journalNotes = journal.querySelector('.journal-notes');
      if (!journalNotes || journalNotes.textContent.trim() === '') return;
      
      // Extrahiere Journal-ID aus dem Element
      const journalId = extractJournalId(journal);
      if (!journalId) return;
      
      // Prüfe ob bereits ein Move-Formular existiert
      if (journal.querySelector('.journal-move-inline')) return;
      
      // Erstelle inline Move-Formular
      const moveForm = createInlineMoveForm(journalId);
      
      // Füge das Formular nach dem Journal-Inhalt hinzu
      journalNotes.parentNode.insertBefore(moveForm, journalNotes.nextSibling);
    });
  }
  
  function isMailHandlerTicket() {
    // Prüfe ob das Ticket vom Mail Handler Plugin erstellt wurde
    const customFields = document.querySelectorAll('.custom-field');
    for (let field of customFields) {
      const label = field.querySelector('.label');
      if (label && label.textContent.includes('Mail Handler')) {
        return true;
      }
    }
    
    // Fallback: Prüfe Tracker oder andere Indikatoren
    const tracker = document.querySelector('.tracker');
    if (tracker && tracker.textContent.includes('Mail')) {
      return true;
    }
    
    return false;
  }
  
  function extractJournalId(journalElement) {
    // Versuche Journal-ID aus verschiedenen Attributen zu extrahieren
    const id = journalElement.id;
    if (id && id.startsWith('change-')) {
      return id.replace('change-', '');
    }
    
    // Fallback: Suche nach Journal-ID in Links
    const editLink = journalElement.querySelector('a[href*="/journals/"]');
    if (editLink) {
      const match = editLink.href.match(/\/journals\/(\d+)/);
      if (match) return match[1];
    }
    
    return null;
  }
  
  function createInlineMoveForm(journalId) {
    const formContainer = document.createElement('div');
    formContainer.className = 'journal-move-inline';
    
    formContainer.innerHTML = `
      <div class="move-form">
        <span class="move-label">Verschieben nach Ticket:</span>
        <input type="number" class="target-input" placeholder="ID" min="1" data-journal-id="${journalId}">
        <button type="button" class="move-btn" onclick="performJournalMove(${journalId}, this)">Verschieben</button>
      </div>
    `;
    
    return formContainer;
  }
  
  function performJournalMove(journalId, buttonElement) {
    const input = buttonElement.parentNode.querySelector('.target-input');
    const targetIssueId = input.value.trim();
    
    if (!targetIssueId || targetIssueId < 1) {
      alert('Bitte geben Sie eine gültige Ticket-ID ein.');
      input.focus();
      return;
    }
    
    // Button deaktivieren während der Anfrage
    buttonElement.disabled = true;
    buttonElement.textContent = 'Verschiebe...';
    
    // AJAX-Request
    fetch('/admin/mail_handler_logs/move_journal', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({
        journal_id: journalId,
        target_issue_id: targetIssueId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Kommentar und Dateien erfolgreich verschoben!');
        location.reload();
      } else {
        alert('Fehler: ' + (data.message || data.error));
        buttonElement.disabled = false;
        buttonElement.textContent = 'Verschieben';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ein Fehler ist aufgetreten.');
      buttonElement.disabled = false;
      buttonElement.textContent = 'Verschieben';
    });
  }
  
  // Enter-Taste Support für Eingabefelder
  document.addEventListener('keypress', function(e) {
    if (e.target.classList.contains('target-input') && e.key === 'Enter') {
      const journalId = e.target.getAttribute('data-journal-id');
      const button = e.target.parentNode.querySelector('.move-btn');
      if (button && journalId) {
        performJournalMove(parseInt(journalId), button);
      }
    }
  });
</script>