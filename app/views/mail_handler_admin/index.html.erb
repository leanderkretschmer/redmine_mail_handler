<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'mail_handler', :plugin => 'redmine_mail_handler' %>
<% end %>

<div class="contextual">
  <%= link_to 'Plugin-Konfiguration', { :controller => 'settings', :action => 'plugin', :id => 'redmine_mail_handler' }, :class => 'icon icon-settings' %>
</div>

<h2>Mail Handler Administration</h2>

<div class="box">
  <h3>System-Status</h3>
  <table class="list">
    <tr>
      <td><strong>Scheduler-Status:</strong></td>
      <td>
        <% if @scheduler_running %>
          <span class="status-running">Läuft</span>
          <%= link_to 'Stoppen', { :action => 'toggle_scheduler' }, :method => :post, :class => 'icon icon-del' %>
          <%= link_to 'Neu starten', { :action => 'restart_scheduler' }, :method => :post, :class => 'icon icon-reload' %>
        <% else %>
          <span class="status-stopped">Gestoppt</span>
          <%= link_to 'Starten', { :action => 'toggle_scheduler' }, :method => :post, :class => 'icon icon-play' %>
        <% end %>
      </td>
    </tr>
    <tr>
      <td><strong>Automatischer Import:</strong></td>
      <td><%= @settings['auto_import_enabled'] == '1' ? 'Aktiviert' : 'Deaktiviert' %></td>
    </tr>
  </table>
</div>

<div class="box">
  <h3>Zurückgestellte Mails</h3>
  <% deferred_stats = @service.count_deferred_messages rescue { total: 0, active: 0, expired: 0 } %>
  <p>
    <%= deferred_stats[:active] %> aktiv, <%= deferred_stats[:expired] %> abgelaufen.
    <%= link_to 'Details anzeigen', { :action => 'deferred_mails' }, :class => 'icon icon-time' %>
    |
    <%= link_to 'Jetzt verarbeiten', { :action => 'process_deferred' }, :method => :post, :class => 'icon icon-reload' %>
  </p>
</div>

<div class="box">
  <h3>Manueller Import</h3>
  <%= form_tag({ :action => 'manual_import' }, :method => :post) do %>
    <p>
      <label for="import_limit">Anzahl E-Mails (leer = alle):</label>
      <%= text_field_tag 'import_limit', '', :size => 10, :placeholder => '10' %>
      <%= submit_tag 'Manuellen Import starten', :confirm => 'Sind Sie sicher?' %>
    </p>
  <% end %>
</div>

<div class="box">
  <h3>Test-E-Mail</h3>
  <%= form_tag({ :action => 'test_mail' }, :method => :post) do %>
    <p>
      <label for="test_email">E-Mail-Adresse:</label>
      <%= text_field_tag 'test_email', '', :size => 30, :placeholder => 'test@example.com' %>
      <%= submit_tag 'Test-E-Mail senden' %>
    </p>
  <% end %>
</div>

