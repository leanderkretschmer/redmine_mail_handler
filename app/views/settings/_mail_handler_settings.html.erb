<div class="box tabular settings">
  <h3>IMAP-Einstellungen</h3>
  
  <p>
    <label for="settings_imap_host">IMAP-Server:</label>
    <%= text_field_tag 'settings[imap_host]', @settings['imap_host'], :size => 30, :placeholder => 'imap.example.com' %>
  </p>
  
  <p>
    <label for="settings_imap_port">Port:</label>
    <%= text_field_tag 'settings[imap_port]', @settings['imap_port'], :size => 10, :placeholder => '993' %>
  </p>
  
  <p>
    <label for="settings_imap_ssl">SSL verwenden:</label>
    <%= check_box_tag 'settings[imap_ssl]', '1', @settings['imap_ssl'] == '1' %>
  </p>
  
  <p>
    <label for="settings_imap_username">Benutzername:</label>
    <%= text_field_tag 'settings[imap_username]', @settings['imap_username'], :size => 30 %>
  </p>
  
  <p>
    <label for="settings_imap_password">Passwort:</label>
    <%= password_field_tag 'settings[imap_password]', @settings['imap_password'], :size => 30 %>
  </p>
  
  <p>
    <label>&nbsp;</label>
    <button type="button" id="test_imap_connection" class="test-connection-btn">IMAP-Verbindung testen</button>
    <span id="imap_test_status" class="connection-status"></span>
  </p>
  
  <p>
    <label for="settings_inbox_folder">Posteingang-Ordner:</label>
    <select name="settings[inbox_folder]" id="settings_inbox_folder">
      <option value="<%= @settings['inbox_folder'] %>"><%= @settings['inbox_folder'].present? ? @settings['inbox_folder'] : 'INBOX' %></option>
    </select>
    <button type="button" id="load_inbox_folders" class="small-button">Ordner laden</button>
    <span id="inbox_loading" style="display: none;">Lade...</span>
  </p>
  
  <p>
    <label for="settings_archive_folder">Archiv-Ordner:</label>
    <select name="settings[archive_folder]" id="settings_archive_folder">
      <option value="<%= @settings['archive_folder'] %>"><%= @settings['archive_folder'].present? ? @settings['archive_folder'] : 'Archive' %></option>
    </select>
    <button type="button" id="load_archive_folders" class="small-button">Ordner laden</button>
    <span id="archive_loading" style="display: none;">Lade...</span>
  </p>
  
</div>

<div class="box tabular settings">
  <h3>Zurückgestellte Mails</h3>
  
  <p>
    <label for="settings_deferred_enabled">Zurückstellung aktiviert:</label>
    <%= check_box_tag 'settings[deferred_enabled]', '1', @settings['deferred_enabled'] == '1' %>
    <em class="info">Aktiviert die Zurückstellung-Funktion für unbekannte Benutzer</em>
  </p>
  
  <p>
    <label for="settings_deferred_folder">Zurückgestellt-Ordner:</label>
    <select name="settings[deferred_folder]" id="settings_deferred_folder">
      <option value="<%= @settings['deferred_folder'] %>"><%= @settings['deferred_folder'].present? ? @settings['deferred_folder'] : 'Deferred' %></option>
    </select>
    <button type="button" id="load_deferred_folders" class="small-button">Ordner laden</button>
    <span id="deferred_loading" style="display: none;">Lade...</span>
  </p>
  
  <p>
    <label for="settings_deferred_lifetime_days">Aufbewahrungszeit (Tage):</label>
    <%= text_field_tag 'settings[deferred_lifetime_days]', @settings['deferred_lifetime_days'] || '30', :size => 10, :placeholder => '30' %>
    <em class="info">Anzahl Tage, die Mails von unbekannten Benutzern zurückgestellt bleiben</em>
  </p>
  
  <p>
    <label for="settings_deferred_recheck_time">Prüfzeit:</label>
    <%= text_field_tag 'settings[deferred_recheck_time]', @settings['deferred_recheck_time'] || '02:00', :size => 10, :placeholder => '02:00' %>
    <em class="info">Uhrzeit für tägliche Zurückgestellt-Prüfung (HH:MM)</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>SMTP-Einstellungen</h3>
  
  <p>
    <label for="settings_smtp_same_as_imap">SMTP = IMAP verwenden:</label>
    <%= check_box_tag 'settings[smtp_same_as_imap]', '1', @settings['smtp_same_as_imap'] == '1', :onchange => 'toggleSmtpFields(this.checked)' %>
    <em class="info">Wenn aktiviert, werden die IMAP-Einstellungen auch für SMTP verwendet</em>
  </p>
  
  <div id="smtp_fields" style="<%= @settings['smtp_same_as_imap'] == '1' ? 'display: none;' : '' %>">
    <p>
      <label for="settings_smtp_host">SMTP-Server:</label>
      <%= text_field_tag 'settings[smtp_host]', @settings['smtp_host'], :size => 30, :placeholder => 'smtp.example.com' %>
    </p>
    
    <p>
      <label for="settings_smtp_port">Port:</label>
      <%= text_field_tag 'settings[smtp_port]', @settings['smtp_port'], :size => 10, :placeholder => '587' %>
    </p>
    
    <p>
      <label for="settings_smtp_ssl">SSL/TLS verwenden:</label>
      <%= check_box_tag 'settings[smtp_ssl]', '1', @settings['smtp_ssl'] == '1' %>
    </p>
    
    <p>
      <label for="settings_smtp_username">Benutzername:</label>
      <%= text_field_tag 'settings[smtp_username]', @settings['smtp_username'], :size => 30 %>
    </p>
    
    <p>
      <label for="settings_smtp_password">Passwort:</label>
      <%= password_field_tag 'settings[smtp_password]', @settings['smtp_password'], :size => 30 %>
    </p>
    
    <p>
      <label>&nbsp;</label>
      <button type="button" id="test_smtp_connection" class="test-connection-btn">SMTP-Verbindung testen</button>
      <span id="smtp_test_status" class="connection-status"></span>
    </p>
  </div>

</div>

<style>
.test-connection-btn {
  padding: 5px 10px;
  margin-right: 10px;
  background-color: #007cba;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.test-connection-btn:hover {
  background-color: #005a87;
}

.test-connection-btn:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.connection-status {
  padding: 5px 10px;
  border-radius: 3px;
  font-weight: bold;
  display: none;
}

.connection-status.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  display: inline-block;
}

.connection-status.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  display: inline-block;
}

.connection-status.testing {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
  display: inline-block;
}
</style>

<script>
function toggleSmtpFields(useImapSettings) {
  var smtpFields = document.getElementById('smtp_fields');
  if (useImapSettings) {
    smtpFields.style.display = 'none';
  } else {
    smtpFields.style.display = 'block';
  }
}

function loadImapFolders(targetSelectId, loadingSpanId) {
  var loadingSpan = document.getElementById(loadingSpanId);
  var targetSelect = document.getElementById(targetSelectId);
  
  // Zeige Loading-Indikator
  loadingSpan.style.display = 'inline';
  
  // Sammle IMAP-Einstellungen
  var imapSettings = {
    imap_host: document.getElementById('settings_imap_host').value,
    imap_port: document.getElementById('settings_imap_port').value,
    imap_ssl: document.getElementById('settings_imap_ssl').checked ? '1' : '0',
    imap_username: document.getElementById('settings_imap_username').value,
    imap_password: document.getElementById('settings_imap_password').value
  };
  
  // Validiere Eingaben
  if (!imapSettings.imap_host || !imapSettings.imap_username || !imapSettings.imap_password) {
    alert('Bitte füllen Sie zuerst alle IMAP-Einstellungen aus.');
    loadingSpan.style.display = 'none';
    return;
  }
  
  // AJAX-Request
  fetch('/admin/mail_handler_admin/get_imap_folders', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify(imapSettings)
  })
  .then(response => response.json())
  .then(data => {
    loadingSpan.style.display = 'none';
    
    if (data.success && data.folders) {
      // Leere das Select und füge neue Optionen hinzu
      targetSelect.innerHTML = '';
      
      data.folders.forEach(function(folder) {
        var option = document.createElement('option');
        option.value = folder;
        option.textContent = folder;
        targetSelect.appendChild(option);
      });
      
      if (data.folders.length === 0) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Keine Ordner gefunden';
        targetSelect.appendChild(option);
      }
    } else {
      alert('Fehler beim Laden der Ordner: ' + (data.error || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    loadingSpan.style.display = 'none';
    alert('Fehler beim Laden der Ordner: ' + error.message);
  });
}

// Funktion zum Testen der IMAP-Verbindung
function testImapConnection() {
  var button = document.getElementById('test_imap_connection');
  var status = document.getElementById('imap_test_status');
  
  // Button deaktivieren und Status auf "Teste..." setzen
  button.disabled = true;
  status.className = 'connection-status testing';
  status.textContent = 'Teste Verbindung...';
  
  // IMAP-Einstellungen sammeln
  var imapSettings = {
    imap_host: document.getElementById('settings_imap_host').value,
    imap_port: document.getElementById('settings_imap_port').value,
    imap_ssl: document.getElementById('settings_imap_ssl').checked ? '1' : '0',
    imap_username: document.getElementById('settings_imap_username').value,
    imap_password: document.getElementById('settings_imap_password').value
  };
  
  // Validierung
  if (!imapSettings.imap_host || !imapSettings.imap_username || !imapSettings.imap_password) {
    status.className = 'connection-status error';
    status.textContent = 'Bitte füllen Sie alle IMAP-Felder aus';
    button.disabled = false;
    return;
  }
  
  // AJAX-Request
  fetch('/admin/mail_handler_admin/test_imap_connection', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify(imapSettings)
  })
  .then(response => response.json())
  .then(data => {
    button.disabled = false;
    
    if (data.success) {
      status.className = 'connection-status success';
      status.textContent = '✓ ' + data.message;
    } else {
      status.className = 'connection-status error';
      status.textContent = '✗ ' + (data.error || 'Unbekannter Fehler');
    }
  })
  .catch(error => {
    button.disabled = false;
    status.className = 'connection-status error';
    status.textContent = '✗ Fehler: ' + error.message;
  });
}

// Funktion zum Testen der SMTP-Verbindung
function testSmtpConnection() {
  var button = document.getElementById('test_smtp_connection');
  var status = document.getElementById('smtp_test_status');
  
  // Button deaktivieren und Status auf "Teste..." setzen
  button.disabled = true;
  status.className = 'connection-status testing';
  status.textContent = 'Teste Verbindung...';
  
  // SMTP-Einstellungen sammeln
  var smtpSettings = {
    smtp_host: document.getElementById('settings_smtp_host').value,
    smtp_port: document.getElementById('settings_smtp_port').value,
    smtp_ssl: document.getElementById('settings_smtp_ssl').checked ? '1' : '0',
    smtp_username: document.getElementById('settings_smtp_username').value,
    smtp_password: document.getElementById('settings_smtp_password').value
  };
  
  // Validierung
  if (!smtpSettings.smtp_host || !smtpSettings.smtp_username || !smtpSettings.smtp_password) {
    status.className = 'connection-status error';
    status.textContent = 'Bitte füllen Sie alle SMTP-Felder aus';
    button.disabled = false;
    return;
  }
  
  // AJAX-Request
  fetch('/admin/mail_handler_admin/test_smtp_connection', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify(smtpSettings)
  })
  .then(response => response.json())
  .then(data => {
    button.disabled = false;
    
    if (data.success) {
      status.className = 'connection-status success';
      status.textContent = '✓ ' + data.message;
    } else {
      status.className = 'connection-status error';
      status.textContent = '✗ ' + (data.error || 'Unbekannter Fehler');
    }
  })
  .catch(error => {
    button.disabled = false;
    status.className = 'connection-status error';
    status.textContent = '✗ Fehler: ' + error.message;
  });
}

// Event Listener für die Buttons (robust mit Null-Prüfung und Turbo-Unterstützung)
function bindSettingsHandlers() {
  var el;

  el = document.getElementById('load_inbox_folders');
  if (el && !el.dataset.bound) {
    el.addEventListener('click', function() {
      loadImapFolders('settings_inbox_folder', 'inbox_loading');
    });
    el.dataset.bound = '1';
  }

  el = document.getElementById('load_archive_folders');
  if (el && !el.dataset.bound) {
    el.addEventListener('click', function() {
      loadImapFolders('settings_archive_folder', 'archive_loading');
    });
    el.dataset.bound = '1';
  }

  el = document.getElementById('load_deferred_folders');
  if (el && !el.dataset.bound) {
    el.addEventListener('click', function() {
      loadImapFolders('settings_deferred_folder', 'deferred_loading');
    });
    el.dataset.bound = '1';
  }

  el = document.getElementById('test_imap_connection');
  if (el && !el.dataset.bound) {
    el.addEventListener('click', testImapConnection);
    el.dataset.bound = '1';
  }

  el = document.getElementById('test_smtp_connection');
  if (el && !el.dataset.bound) {
    el.addEventListener('click', testSmtpConnection);
    el.dataset.bound = '1';
  }
}

document.addEventListener('DOMContentLoaded', bindSettingsHandlers);
document.addEventListener('turbo:load', bindSettingsHandlers);
</script>

<div class="box tabular settings">
  <h3>Ticket-Einstellungen</h3>
  
  <p>
    <label for="settings_inbox_ticket_id">Posteingang-Ticket-ID:</label>
    <%= text_field_tag 'settings[inbox_ticket_id]', @settings['inbox_ticket_id'], :size => 10, :placeholder => '1' %>
    <button type="button" onclick="document.getElementById('settings_inbox_ticket_id').value='';" class="small-button">Leeren</button>
    <em class="info">ID des Tickets, an das E-Mails von bekannten Absendern ohne Ticket-ID angehängt werden</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>Reminder-Einstellungen</h3>
  
  <p>
    <label for="settings_reminder_enabled">Tägliche Reminder aktiviert:</label>
    <%= check_box_tag 'settings[reminder_enabled]', '1', @settings['reminder_enabled'] == '1' %>
  </p>
  
  <p>
    <label for="settings_reminder_time">Reminder-Zeit:</label>
    <%= text_field_tag 'settings[reminder_time]', @settings['reminder_time'], :size => 10, :placeholder => '09:00' %>
    <em class="info">Format: HH:MM (24-Stunden-Format)</em>
  </p>
  
  <p>
    <label for="settings_reminder_type">Reminder-Typ:</label>
    <%= select_tag 'settings[reminder_type]', 
                   options_for_select([
                     ['Redmine Standard-Reminder', 'redmine'],
                     ['Plugin Custom-Reminder', 'custom']
                   ], @settings['reminder_type'] || 'redmine') %>
    <em class="info">Redmine Standard nutzt eingebaute Funktionalität, Custom nutzt Plugin-eigene Implementierung</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>Import-Einstellungen</h3>
  
  <p>
    <label for="settings_auto_import_enabled">Automatischer Import aktiviert:</label>
    <%= check_box_tag 'settings[auto_import_enabled]', '1', @settings['auto_import_enabled'] == '1' %>
  </p>
  
  <p>
    <label for="settings_import_interval">Import-Intervall:</label>
    <%= text_field_tag 'settings[import_interval]', @settings['import_interval'], :size => 10, :placeholder => '5' %>
    <%= select_tag 'settings[import_interval_unit]', 
                   options_for_select([
                     ['Minuten', 'minutes'],
                     ['Sekunden', 'seconds']
                   ], @settings['import_interval_unit'] || 'minutes') %>
    <em class="info">Wie oft sollen E-Mails automatisch importiert werden</em>
  </p>
  
  <p>
    <label for="settings_mails_per_hour">Mails pro Stunde (Load-Balanced):</label>
    <%= text_field_tag 'settings[mails_per_hour]', @settings['mails_per_hour'] || '60', :size => 10, :placeholder => '60' %>
    <em class="info">Maximale Anzahl Mails, die pro Stunde gleichmäßig verteilt importiert werden (0 = unbegrenzt)</em>
  </p>
  
  <p>
    <label for="settings_load_balanced_enabled">Load-Balanced Import aktiviert:</label>
    <%= check_box_tag 'settings[load_balanced_enabled]', '1', @settings['load_balanced_enabled'] == '1' %>
    <em class="info">Verteilt den Import gleichmäßig über die Stunde statt alle Mails auf einmal zu importieren</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>Benutzer-Erstellung</h3>
  
  <p>
    <label for="settings_user_firstname_type">Vorname für neue Benutzer:</label>
    <%= select_tag 'settings[user_firstname_type]', 
                   options_for_select([
                     ['Mail-Account (Teil vor @)', 'mail_account'],
                     ['Vollständige E-Mail-Adresse', 'mail_address']
                   ], @settings['user_firstname_type'] || 'mail_account') %>
    <em class="info">Bestimmt, wie der Vorname für automatisch erstellte Benutzer generiert wird</em>
  </p>
  
  <p>
    <label for="settings_user_lastname_custom">Nachname für neue Benutzer:</label>
    <%= text_field_tag 'settings[user_lastname_custom]', @settings['user_lastname_custom'] || 'Auto-generated', :size => 30, :placeholder => 'Auto-generated' %>
    <em class="info">Benutzerdefinierter Nachname für alle automatisch erstellten Benutzer</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>E-Mail-Filter</h3>
  
  <p>
    <label for="settings_ignore_email_addresses">Zu ignorierende E-Mail-Adressen:</label>
    <%= text_area_tag 'settings[ignore_email_addresses]', @settings['ignore_email_addresses'], :rows => 5, :placeholder => 'Eine E-Mail-Adresse pro Zeile, z.B.:\n*@system.example.com\nnoreply@company.com\nautomation@*' %>
    <em class="info">E-Mails von diesen Adressen werden automatisch in den zurückgestellt Ordner verschoben und nach 30 Tagen archiviert. Wildcards (*) sind erlaubt.</em>
  </p>
</div>

<div class="box tabular settings">
  <h3>Logging-Einstellungen</h3>
  
  <p>
    <label for="settings_log_level">Log-Level:</label>
    <%= select_tag 'settings[log_level]', 
                   options_for_select([
                     ['Debug', 'debug'],
                     ['Info', 'info'],
                     ['Warning', 'warn'],
                     ['Error', 'error']
                   ], @settings['log_level']) %>
  </p>
</div>

<div class="box">
  <h3>Hilfe</h3>
  <p>
    <strong>IMAP-Einstellungen:</strong> Konfigurieren Sie hier die Verbindung zu Ihrem E-Mail-Server.
  </p>
  <p>
    <strong>SMTP-Einstellungen:</strong> Konfigurieren Sie hier die SMTP-Einstellungen für den E-Mail-Versand. Wenn "SMTP = IMAP verwenden" aktiviert ist, werden die IMAP-Einstellungen automatisch für SMTP verwendet (z.B. imap.example.com wird zu smtp.example.com).
  </p>
  <p>
    <strong>Posteingang-Ticket-ID:</strong> Geben Sie die ID eines existierenden Tickets an, an das alle E-Mails von bekannten Absendern ohne Ticket-ID angehängt werden sollen.
  </p>
  <p>
    <strong>Archiv-Ordner:</strong> E-Mails werden nach der Verarbeitung in diesen Ordner verschoben. Lassen Sie das Feld leer, um die Archivierung zu deaktivieren.
  </p>
  <p>
    <strong>Automatischer Import:</strong> Wenn aktiviert, werden E-Mails automatisch im angegebenen Intervall importiert. Deaktivieren Sie dies für manuellen Import in der Entwicklung.
  </p>
  <p>
    <strong>Benutzer-Erstellung:</strong> Konfigurieren Sie hier, wie Vor- und Nachname für automatisch erstellte Benutzer generiert werden. Der Vorname kann entweder der Teil vor dem @ der E-Mail-Adresse oder die vollständige E-Mail-Adresse sein. Der Nachname ist frei konfigurierbar.
  </p>
  <p>
    <strong>E-Mail-Filter:</strong> E-Mails von den hier konfigurierten Adressen werden automatisch in den zurückgestellt Ordner verschoben und nach 30 Tagen archiviert. Wildcards (*) sind erlaubt, z.B. *@system.example.com für alle E-Mails von system.example.com oder automation@* für alle E-Mails von automation, unabhängig von der Domain.
  </p>
</div>