<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'mail_handler', :plugin => 'redmine_mail_handler' %>
<% end %>

<div class="contextual">
  <%= link_to 'Logs anzeigen', { :controller => 'mail_handler_logs', :action => 'index' }, :class => 'icon icon-list' %>
</div>

<h2>Mail Handler Administration</h2>

<div class="box">
  <h3>System-Status</h3>
  <table class="list">
    <tr>
      <td><strong>Scheduler-Status:</strong></td>
      <td>
        <% if @scheduler_running %>
          <span class="status-running">Läuft</span>
          <%= link_to 'Stoppen', { :action => 'toggle_scheduler' }, :method => :post, :class => 'icon icon-del' %>
          <%= link_to 'Neu starten', { :action => 'restart_scheduler' }, :method => :post, :class => 'icon icon-reload' %>
        <% else %>
          <span class="status-stopped">Gestoppt</span>
          <%= link_to 'Starten', { :action => 'toggle_scheduler' }, :method => :post, :class => 'icon icon-play' %>
        <% end %>
      </td>
    </tr>
    <tr>
      <td><strong>Automatischer Import:</strong></td>
      <td><%= @settings['auto_import_enabled'] == '1' ? 'Aktiviert' : 'Deaktiviert' %></td>
    </tr>
    <tr>
      <td><strong>Import-Intervall:</strong></td>
      <td>
        <%= @settings['import_interval'] %> 
        <%= (@settings['import_interval_unit'] == 'seconds') ? 'Sekunden' : 'Minuten' %>
      </td>
    </tr>
    <tr>
      <td><strong>Tägliche Reminder:</strong></td>
      <td><%= @settings['reminder_enabled'] == '1' ? "Aktiviert (#{@settings['reminder_time']})" : 'Deaktiviert' %></td>
    </tr>
    <tr>
      <td><strong>Aktionen:</strong></td>
      <td class="buttons">
        <%= link_to 'Manueller Import', { :action => 'manual_import' }, :method => :post, :class => 'icon icon-email' %>
        <%= link_to 'Test-Mail senden', { :action => 'test_mail' }, :method => :post, :class => 'icon icon-email-go' %>
        <%= link_to 'Zurückgestellt verarbeiten', { :action => 'process_deferred' }, :method => :post, :class => 'icon icon-reload' %>
        <% if @settings['inbox_ticket_id'].present? && @settings['inbox_ticket_id'].to_i > 0 %>
          <%= link_to 'Kommentar verschieben', 
                       "#", 
                       :class => 'icon icon-move move-comment-btn',
                       :onclick => 'showMoveCommentDialog(); return false;',
                       :title => "Verschiebt einen Kommentar aus Ticket ##{@settings['inbox_ticket_id']} zu einem anderen Ticket" %>
          <%= link_to 'Alle Kommentare & Dateien löschen', 
                       { :action => 'delete_all_comments' }, 
                       :method => :post, 
                       :class => 'icon icon-del delete-comments-btn',
                       :confirm => 'Sind Sie sicher, dass Sie alle Kommentare und angehängten Dateien aus dem Posteingang-Ticket löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden!',
                       :title => "Löscht alle Kommentare und Dateien aus Ticket ##{@settings['inbox_ticket_id']}" %>
        <% end %>
      </td>
    </tr>
  </table>
</div>

<div class="box">
  <h3>Zurückgestellt-Status</h3>
  <div id="deferred-status">
     <% begin %>
       <% deferred_stats = {
            total: MailDeferredEntry.count,
            active: MailDeferredEntry.active.count,
            expired: MailDeferredEntry.expired.count
          } %>
     <% rescue ActiveRecord::StatementInvalid => e %>
       <% deferred_stats = { total: 0, active: 0, expired: 0 } %>
       <div class="flash error">Zurückgestellt-Tabelle nicht gefunden. Bitte führen Sie die Datenbankmigrationen aus.</div>
     <% end %>
    <table class="list">
      <tr>
        <td><strong>Zurückgestellte Mails:</strong></td>
        <td><%= deferred_stats[:active] %> aktiv, <%= deferred_stats[:expired] %> abgelaufen</td>
      </tr>
      <tr>
        <td><strong>Zurückgestellt-Ordner:</strong></td>
        <td><%= @settings['deferred_folder'] || 'Deferred' %></td>
      </tr>
      <tr>
        <td><strong>Aufbewahrungszeit:</strong></td>
        <td><%= @settings['deferred_lifetime_days'] || '30' %> Tage</td>
      </tr>
      <tr>
        <td><strong>Prüfzeit:</strong></td>
        <td><%= @settings['deferred_recheck_time'] || '02:00' %></td>
      </tr>
    </table>
    
    <p>
      <%= link_to 'Zurückgestellt-Details', { :action => 'deferred_status' }, :class => 'icon icon-list' %>
    </p>
  </div>
</div>

<div class="box">
  <h3>Load-Balanced Importing</h3>
  <table class="list">
    <tr>
      <td><strong>Load-Balancing:</strong></td>
      <td><%= @load_balanced_enabled ? 'Aktiviert' : 'Deaktiviert' %></td>
    </tr>
    <tr>
      <td><strong>Max. parallele Imports:</strong></td>
      <td><%= @max_parallel_imports %></td>
    </tr>
    <tr>
      <td><strong>Import-Batch-Größe:</strong></td>
      <td><%= @import_batch_size %> E-Mails pro Batch</td>
    </tr>
    <tr>
      <td><strong>Worker-Timeout:</strong></td>
      <td><%= @worker_timeout %> Sekunden</td>
    </tr>
  </table>
  <p>
    <%= form_tag({ :action => 'toggle_load_balancing' }, :method => :post) do %>
      <%= submit_tag (@load_balanced_enabled ? 'Load-Balancing deaktivieren' : 'Load-Balancing aktivieren'), :class => 'icon icon-settings' %>
    <% end %>
  </p>
  <p><em>Load-Balanced Importing verteilt große E-Mail-Mengen auf mehrere Worker-Prozesse für bessere Performance.</em></p>
</div>

<div class="box">
  <h3>IMAP-Verbindung testen</h3>
  <p>Testen Sie die Verbindung zu Ihrem IMAP-Server:</p>
  <%= link_to 'IMAP-Verbindung testen', { :action => 'test_connection' }, :method => :post, :class => 'icon icon-test' %>
</div>

<div class="box">
  <h3>Test-E-Mail senden</h3>
  <%= form_tag({ :action => 'test_mail' }, :method => :post) do %>
    <p>
      <label for="test_email">E-Mail-Adresse:</label>
      <%= text_field_tag 'test_email', '', :size => 30, :placeholder => 'test@example.com' %>
      <%= submit_tag 'Test-E-Mail senden' %>
    </p>
  <% end %>
</div>

<div class="box">
  <h3>Test-Reminder senden</h3>
  <%= form_tag({ :action => 'test_reminder' }, :method => :post) do %>
    <p>
      <label for="reminder_email">E-Mail-Adresse:</label>
      <%= text_field_tag 'reminder_email', '', :size => 30, :placeholder => 'test@example.com' %>
      <%= submit_tag 'Test-Reminder senden' %>
    </p>
  <% end %>
</div>

<div class="box">
  <h3>Bulk-Reminder senden</h3>
  <p>Sendet Reminder-E-Mails an alle Benutzer mit offenen Tickets:</p>
  <%= form_tag({ :action => 'send_bulk_reminder' }, :method => :post) do %>
    <p>
      <%= submit_tag 'Bulk-Reminder an alle senden', :confirm => 'Sind Sie sicher, dass Sie Reminder-E-Mails an alle Benutzer senden möchten?' %>
    </p>
  <% end %>
</div>

<div class="box">
  <h3>Manueller E-Mail-Import</h3>
  <p>Für Entwicklung und Tests können Sie E-Mails manuell importieren:</p>
  <%= form_tag({ :action => 'manual_import' }, :method => :post) do %>
    <p>
      <label for="import_limit">Anzahl E-Mails (leer = alle):</label>
      <%= text_field_tag 'import_limit', '', :size => 10, :placeholder => '10' %>
      <%= submit_tag 'Manuellen Import starten', :confirm => 'Sind Sie sicher, dass Sie den manuellen Import starten möchten?' %>
    </p>
  <% end %>
</div>

<div class="box">
  <h3>Log-Verwaltung</h3>
  <p>Verwalten Sie die Plugin-Logs:</p>
  <p>
    <%= link_to 'Alle Logs anzeigen', { :controller => 'mail_handler_logs', :action => 'index' }, :class => 'icon icon-list' %>
    <%= link_to 'Alte Logs löschen (>30 Tage)', { :action => 'cleanup_old_logs' }, :method => :post, :class => 'icon icon-del', :confirm => 'Sind Sie sicher?' %>
    <%= link_to 'Alle Logs löschen', { :action => 'clear_logs' }, :method => :post, :class => 'icon icon-del', :confirm => 'Sind Sie sicher, dass Sie alle Logs löschen möchten?' %>
  </p>
</div>

<% if @recent_logs.any? %>
<div class="box">
  <h3>Aktuelle Logs (letzte 10 Einträge)</h3>
  <table class="list logs">
    <thead>
      <tr>
        <th>Zeit</th>
        <th>Level</th>
        <th>Nachricht</th>
      </tr>
    </thead>
    <tbody>
      <% @recent_logs.each do |log| %>
        <tr class="log-<%= log.level %>">
          <td class="log-time"><%= log.formatted_time %></td>
          <td class="log-level">
            <span class="<%= log.level_icon %>" style="color: <%= log.level_color %>"></span>
            <%= log.level.upcase %>
          </td>
          <td class="log-message"><%= truncate(log.message, length: 100) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <p class="pagination">
    <%= link_to 'Alle Logs anzeigen →', { :controller => 'mail_handler_logs', :action => 'index' } %>
  </p>
</div>
<% end %>

<!-- Dialog für Kommentar verschieben -->
<div id="move-comment-dialog" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Kommentar verschieben</h3>
      <span class="close" onclick="closeMoveCommentDialog()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="journal-id">Journal-ID des zu verschiebenden Kommentars:</label>
        <input type="number" id="journal-id" name="journal_id" placeholder="z.B. 12345" required>
        <small class="help-text">Die Journal-ID finden Sie in der URL beim Bearbeiten eines Kommentars oder in den Entwicklertools.</small>
      </div>
      
      <div class="form-group">
        <label for="target-ticket-id">Ziel-Ticket-ID:</label>
        <input type="number" id="target-ticket-id" name="target_ticket_id" placeholder="z.B. 678" required>
        <small class="help-text">Die ID des Tickets, zu dem der Kommentar verschoben werden soll.</small>
      </div>
      
      <div class="form-group">
        <div class="checkbox">
          <input type="checkbox" id="confirm-move" name="confirm_move" required>
          <label for="confirm-move">Ich bestätige, dass der Kommentar und alle zugehörigen Anhänge verschoben werden sollen.</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" onclick="moveComment()">Kommentar verschieben</button>
      <button type="button" class="btn btn-secondary" onclick="closeMoveCommentDialog()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="move-comment-overlay" class="modal-overlay" style="display: none;" onclick="closeMoveCommentDialog()"></div>

<script>
function showMoveCommentDialog() {
  document.getElementById('move-comment-dialog').style.display = 'block';
  document.getElementById('move-comment-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeMoveCommentDialog() {
  document.getElementById('move-comment-dialog').style.display = 'none';
  document.getElementById('move-comment-overlay').style.display = 'none';
  document.body.style.overflow = 'auto';
  
  // Reset form
  document.getElementById('journal-id').value = '';
  document.getElementById('target-ticket-id').value = '';
  document.getElementById('confirm-move').checked = false;
}

function moveComment() {
  const journalId = document.getElementById('journal-id').value;
  const targetTicketId = document.getElementById('target-ticket-id').value;
  const confirmMove = document.getElementById('confirm-move').checked;
  
  // Validierung
  if (!journalId || !targetTicketId) {
    alert('Bitte füllen Sie alle Felder aus.');
    return;
  }
  
  if (!confirmMove) {
    alert('Bitte bestätigen Sie die Verschiebung.');
    return;
  }
  
  if (!confirm(`Sind Sie sicher, dass Sie den Kommentar #${journalId} zu Ticket #${targetTicketId} verschieben möchten? Diese Aktion kann nicht rückgängig gemacht werden!`)) {
    return;
  }
  
  // Zeige Loading-Indikator
  const button = event.target;
  const originalText = button.textContent;
  button.textContent = 'Verschiebe...';
  button.disabled = true;
  
  // AJAX-Request
  fetch('<%= url_for(:action => 'move_comment') %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({
      journal_id: journalId,
      target_ticket_id: targetTicketId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      closeMoveCommentDialog();
      // Optional: Seite neu laden um aktualisierte Daten zu zeigen
      window.location.reload();
    } else {
      alert('Fehler: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Ein unerwarteter Fehler ist aufgetreten.');
  })
  .finally(() => {
    // Reset button
    button.textContent = originalText;
    button.disabled = false;
  });
}

// ESC-Taste zum Schließen des Dialogs
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeMoveCommentDialog();
  }
});
</script>

<div class="box">
  <h3>Konfiguration</h3>
  <p>Ändern Sie die Plugin-Einstellungen unter:</p>
  <p><%= link_to 'Administration → Plugins → Redmine Mail Handler → Konfiguration', { :controller => 'settings', :action => 'plugin', :id => 'redmine_mail_handler' }, :class => 'icon icon-settings' %></p>
</div>